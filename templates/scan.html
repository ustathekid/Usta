{% extends "base.html" %}

{% block title %}File Comparison - Schemini Manager{% endblock %}

{% block content %}
<style>
.detail-item {
    margin-bottom: 0.75rem;
    padding: 0.5rem;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.8);
    border-left: 3px solid rgba(23, 162, 184, 0.8);
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.detail-item:hover {
    background: rgba(255, 255, 255, 0.95);
    border-left-color: #17a2b8;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.detail-item strong {
    color: #212529;
    font-weight: 700;
    font-size: 0.95rem;
}

.detail-item .text-muted {
    color: #495057 !important;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    margin-top: 0.25rem;
    word-break: break-all;
    font-weight: 500;
}

#operationDetailsSection .card {
    border: 2px solid rgba(23, 162, 184, 0.5);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    background: rgba(248, 249, 250, 0.95);
}

#operationDetailsSection .card-header {
    background: rgba(23, 162, 184, 0.15);
    border-bottom: 1px solid rgba(23, 162, 184, 0.4);
}

#operationDetailsSection .card-title {
    color: #212529;
    font-weight: 700;
}

.operation-actions {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 1rem;
    margin-top: 0.75rem;
    border: 1px solid rgba(23, 162, 184, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.confirmation-text {
    color: #212529;
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 0.75rem;
}

.confirmation-text .highlight {
    color: #17a2b8;
    font-weight: 700;
}

#downloadReportBtn {
    border: 1px solid #17a2b8;
    color: #17a2b8;
    transition: all 0.3s ease;
    font-weight: 600;
}

#downloadReportBtn:hover {
    background-color: #17a2b8;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
}

/* Enhanced Summary Chips for ZIP Downloads */
.summary-chip {
    position: relative;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    padding: 0.75rem 1rem;
    margin: 0.25rem;
    border-radius: 8px;
    font-weight: 600;
}

.summary-chip.clickable {
    cursor: pointer;
    transform: scale(1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-chip.clickable:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.summary-chip.clickable:active {
    transform: translateY(0) scale(0.98);
}

/* ZIP Download Loading State */
.summary-chip.loading {
    pointer-events: none;
    opacity: 0.7;
    position: relative;
}

.summary-chip.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: translateY(-50%) rotate(360deg);
    }
}

.spin {
    animation: spin 1s linear infinite;
}

/* Loading state for input fields */
.loading-input {
    background: linear-gradient(90deg, #f8f9fa 25%, #e9ecef 37%, #f8f9fa 63%);
    background-size: 400% 100%;
    animation: loading-shimmer 1.5s ease-in-out infinite;
}

@keyframes loading-shimmer {
    0% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

@media (max-width: 768px) {
    .detail-item {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
    }
    
    .operation-actions {
        padding: 1rem;
    }
    
    .operation-actions .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    #downloadReportBtn {
        width: 100%;
        margin-top: 1rem;
    }
    
    #postOperationDetails .row {
        flex-direction: column-reverse;
    }
    
    #postOperationDetails .col-md-4 {
        text-align: center !important;
        margin-bottom: 1rem;
    }
    
    .progress-container {
        margin: 0 -0.5rem;
    }
    
    #progressText {
        font-size: 1.1rem !important;
    }
}

/* Enhanced Progress Bar Styling */
.progress-container {
    position: relative;
}

.progress {
    position: relative;
    overflow: visible;
}

.progress-text-center {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
}

#progressBar {
    transition: width 0.3s ease;
}

#cancelScan {
    transition: all 0.3s ease;
}

#cancelScan:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4) !important;
}

/* Enhanced Compare Folder Button Styling */
#btnPickScanFiles {
    border-radius: 10px 0 0 10px;
    transition: all 0.3s ease;
}

#btnPickScanFiles:hover:not(:disabled) {
    filter: brightness(1.1);
    box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
}

/* Change Reference Folder Button consistent styling */
#changeReferenceFolder {
    border-radius: 0 10px 10px 0;
    transition: all 0.3s ease;
}

#changeReferenceFolder:hover {
    filter: brightness(1.1);
    box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
}

/* Step Cards Styling */
.step-card {
    transition: all 0.3s ease;
    border-width: 2px;
}

.step-card.disabled {
    opacity: 0.6;
    pointer-events: none;
}

.step-card.disabled .card-body {
    background: rgba(108, 117, 125, 0.1);
}

.step-card.active {
    border-color: #17a2b8 !important;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
}

.step-card.completed {
    border-color: #28a745 !important;
}

.step-card.completed .step-number .badge {
    background-color: #28a745 !important;
}

.step-number {
    min-width: 50px;
}

/* Updated step number styling */
.step-num {
    font-size: 2rem;
    font-weight: 700;
    color: #17a2b8;
    line-height: 1;
}

.step-card.completed .step-num {
    color: #28a745;
}

.step-card.active .step-num {
    color: #ffc107;
}

.step-card.disabled .step-num {
    color: #6c757d;
}

.step-status {
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    color: #fff;
    font-weight: 500;
}

.step-status.completed {
    color: #28a745;
    font-weight: 600;
}

.step-status.active {
    color: #ffc107;
    font-weight: 600;
}

#sectionsPlaceholder {
    display: block;
}

.step-card:not(.disabled) #sectionsPlaceholder {
    display: none !important;
}

/* Responsive adjustments for step cards */
@media (max-width: 767.98px) {
    .step-card .card-header .d-flex {
        flex-wrap: wrap;
    }
    
    .step-card .card-title {
        font-size: 1rem;
    }
    
    .step-card .text-muted {
        font-size: 0.8rem;
    }
    
    .step-status {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
    }
    
    .step-num {
        font-size: 1.5rem;
    }
}
</style>
<div class="container-fluid px-0">
    <div class="row g-3">
        <div class="col-12">
            <div class="card bg-secondary page-full-card page-flex">
                <div class="card-header">
                    <h2 class="card-title mb-0">
                        <i class="bi bi-search me-2"></i>
                        File Comparison
                    </h2>
                    <p class="card-text mt-2 mb-0">Compare folders and identify files that don't match</p>
                </div>
                <div class="card-body content-area">
                    <!-- File Comparison Form -->
                    <form id="scanForm" class="mb-3">
                        <!-- Steps 1 & 2: Reference and Compare Folder Selection -->
                        <div class="row g-3 mb-3">
                            <!-- Step 1: Reference Folder Selection -->
                            <div class="col-12 col-md-6">
                                <div class="card bg-dark border-primary step-card" id="step1Card">
                                    <div class="card-header py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="step-number me-3">
                                                <span class="step-num">1</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-0">
                                                    <i class="bi bi-folder me-2"></i>
                                                    Reference Folder
                                                </h5>
                                                <small class="text-muted">Main reference folder</small>
                                            </div>
                                            <div>
                                                <span id="step1Status" class="step-status"><i class="bi bi-clock me-1"></i>Pending</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="referenceFolder" value="{{ default_reference_folder }}" placeholder="Select a reference folder..." readonly>
                                            <button class="btn btn-outline-light" type="button" id="changeReferenceFolder">Change</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Compare Folder Selection -->
                            <div class="col-12 col-md-6">
                                <div class="card bg-dark border-secondary step-card disabled" id="step2Card">
                                    <div class="card-header py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="step-number me-3">
                                                <span class="step-num">2</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-0">
                                                    <i class="bi bi-folder2-open me-2"></i>
                                                    Compare Folder
                                                </h5>
                                                <small class="text-muted">Folder to compare</small>
                                            </div>
                                            <div>
                                                <span id="step2Status" class="step-status"><i class="bi bi-pause-circle me-1"></i>Waiting</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <input type="file" id="scanFiles" webkitdirectory directory multiple style="display:none;">
                                        <div class="input-group">
                                            <button type="button" class="btn btn-outline-light" id="btnPickScanFiles" disabled>
                                                <i class="bi bi-folder2-open me-1"></i>
                                                Choose Folder
                                            </button>
                                            <input type="text" class="form-control" id="scanFilesDisplay" placeholder="Complete Step 1 first" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Sections Selection -->
                        <div class="row g-3 mb-3">
                            <div class="col-12">
                                <div class="card bg-dark border-secondary step-card disabled" id="step3Card">
                                    <div class="card-header py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="step-number me-3">
                                                <span class="step-num">3</span>
                                            </div>
                                            <div>
                                                <h5 class="card-title mb-0">
                                                    <i class="bi bi-diagram-3 me-2"></i>
                                                    Select Sections (<span id="scanSectionsCount">0</span> selected)
                                                </h5>
                                                <small class="text-muted">Choose which sections to scan</small>
                                            </div>
                                            <div class="ms-auto">
                                                <span id="step3Status" class="step-status"><i class="bi bi-pause-circle me-1"></i>Waiting</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body pane-body py-2">
                                        <div id="scanSectionsList" class="sections-wrap"></div>
                                        <div id="sectionsPlaceholder" class="text-center text-muted py-3">
                                            <i class="bi bi-arrow-up me-2"></i>
                                            Complete previous steps to select sections
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Step 4: Operation Details Section -->
                    <div id="operationDetailsSection" class="mb-3" style="display: none;">
                        <div class="card bg-dark border-primary">
                            <div class="card-header py-2">
                                <div class="d-flex align-items-center">
                                    <div class="step-number me-3">
                                        <span class="step-num">4</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <span id="operationDetailsTitle">Operation Details</span>
                                        </h5>
                                        <small class="text-muted">Review details and confirm operation</small>
                                    </div>
                                    <div>
                                        <span class="step-status completed"><i class="bi bi-check-circle-fill me-1"></i>Ready</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="operationDetailsContent">
                                    <!-- Pre-operation content -->
                                    <div id="preOperationDetails">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="detail-item">
                                                    <i class="bi bi-folder text-primary me-2"></i>
                                                    <strong>Reference Folder:</strong>
                                                    <div class="ms-4 text-muted" id="detailReferenceFolder">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="detail-item">
                                                    <i class="bi bi-folder2-open text-info me-2"></i>
                                                    <strong>Compare Folder:</strong>
                                                    <div class="ms-4 text-muted" id="detailCompareFolder">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="detail-item">
                                                    <i class="bi bi-files text-warning me-2"></i>
                                                    <strong>Files to Compare:</strong>
                                                    <div class="ms-4 text-muted" id="detailFileCount">0 files</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="detail-item">
                                                    <i class="bi bi-diagram-3 text-success me-2"></i>
                                                    <strong>Selected Sections:</strong>
                                                    <div class="ms-4 text-muted" id="detailSections">None selected</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Confirmation and Action Buttons -->
                                        <div class="operation-actions">
                                            <div class="confirmation-text">
                                                <i class="bi bi-question-circle me-2"></i>
                                                Do you <span class="highlight">confirm</span> the operation details above?
                                            </div>
                                            <div class="d-flex justify-content-center gap-3">
                                                <button type="submit" class="btn btn-success btn-lg px-4" id="confirmStartBtn">
                                                    <i class="bi bi-check-circle me-2"></i>
                                                    Confirm & Start
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-lg px-4" id="cancelOperationBtn">
                                                    <i class="bi bi-x-circle me-2"></i>
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Post-operation content -->
                                    <div id="postOperationDetails" style="display: none;">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="alert alert-info border-0" style="background: rgba(13, 202, 240, 0.1); color: #212529;">
                                                    <div class="d-flex align-items-center">
                                                        <i class="bi bi-info-circle-fill me-2 fs-5" style="color: #0dcaf0;"></i>
                                                        <div>
                                                            <strong>Download Instructions:</strong>
                                                            <div class="mt-1 small">
                                                                Click the buttons below to download matched or non-matched files as ZIP archives. 
                                                                <span class="text-warning fw-semibold">Note: File preparation may take a few moments depending on the number of files.</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div id="operationResultsSummary" class="summary-bar"></div>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <button type="button" class="btn btn-outline-primary btn-lg" id="downloadReportBtn">
                                                    <i class="bi bi-download me-2"></i>
                                                    Download Report
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- ZIP Download Status -->
                                        <div id="zipDownloadStatus" class="mt-3" style="display: none;">
                                            <div class="alert alert-warning border-0 mb-0" style="background: rgba(255, 193, 7, 0.1); color: #212529;">
                                                <div class="d-flex align-items-center">
                                                    <div class="spinner-border spinner-border-sm me-3" role="status" style="color: #ffc107;">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <div>
                                                        <strong id="zipStatusTitle">Preparing files...</strong>
                                                        <div class="small" id="zipStatusMessage">Please wait while we prepare your files for download.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div id="progressSection" class="mb-3" style="display: none;">
                        <div class="progress-container">
                            <div class="progress" style="height: 48px; border-radius: 15px; background-color: rgba(255,255,255,0.2); border: 4px solid rgba(23, 162, 184, 0.6); box-shadow: inset 0 3px 6px rgba(0,0,0,0.15), 0 0 12px rgba(23, 162, 184, 0.3); position: relative;">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%; border-radius: 11px; background: linear-gradient(45deg, #28a745, #20c997, #17a2b8); box-shadow: 0 3px 12px rgba(40, 167, 69, 0.4); position: relative;">
                                </div>
                                <!-- Centered Percentage Text -->
                                <div class="progress-text-center">
                                    <span id="progressText" class="fw-bold text-white" style="font-size: 1.5rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.9), 0 0 10px rgba(255,255,255,0.3); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; letter-spacing: 1px;">0%</span>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small id="progressStatus" class="text-truncate fw-semibold" style="color: #17a2b8; font-size: 1rem;">Ready...</small>
                                <small id="progressCount" class="fw-bold px-3 py-2 rounded" style="color: #ffffff; background-color: #28a745; font-size: 1rem; border-radius: 8px; box-shadow: 0 3px 6px rgba(40, 167, 69, 0.4);">0/0</small>
                            </div>
                            
                            <!-- Centered Cancel Button -->
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-danger btn-lg px-4" id="cancelScan" title="Cancel Operation" style="border-radius: 12px; font-weight: 600; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);">
                                    <i class="bi bi-x-circle-fill me-2"></i>
                                    Cancel Operation
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Section (Compact Summary Bar) -->
                    <div id="resultsSection" class="mb-3" style="display: none;">
                        <div class="card bg-dark">
                            <div class="card-body py-3">
                                <div id="scanResults" class="summary-bar"></div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>



<!-- JavaScript Section -->
<script>
let isScanning = false;
let scanInterval = null;
let progressAnimationInterval = null;
let currentVisualProgress = 0;
let targetProgress = 0;
let selectedTargetFiles = [];
let availableScanSections = [];
let selectedScanSections = [];
let scanJustCompleted = false;  // Flag to track when scan just completed

// Define missing functions
function clearLog() {
    console.log('[SCAN] Log cleared');
}

function addLogEntry(message) {
    console.log('[SCAN]', message);
}

function stopScanning(wasCancelled = false) {
    isScanning = false;
    const confirmBtn = document.getElementById('confirmStartBtn');
    if (confirmBtn) confirmBtn.disabled = false;
    
    const progressSection = document.getElementById('progressSection');
    if (progressSection) progressSection.style.display = 'none';
    
    stopProgressPolling();
    if (progressAnimationInterval) {
        clearInterval(progressAnimationInterval);
        progressAnimationInterval = null;
    }
    
    checkFormValidity();
    
    if (wasCancelled) {
        addLogEntry('🛑 Operation cancelled by user.');
        const resultsSection = document.getElementById('resultsSection');
        if (resultsSection) resultsSection.style.display = 'none';
        
        // Reset operation details to pre-operation state
        const operationDetailsTitle = document.getElementById('operationDetailsTitle');
        const preOperationDetails = document.getElementById('preOperationDetails');
        const postOperationDetails = document.getElementById('postOperationDetails');
        
        if (operationDetailsTitle) operationDetailsTitle.innerHTML = '<i class="bi bi-info-circle me-2"></i>Operation Details';
        if (preOperationDetails) preOperationDetails.style.display = 'block';
        if (postOperationDetails) postOperationDetails.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const scanForm = document.getElementById('scanForm');
    const confirmStartBtn = document.getElementById('confirmStartBtn');
    const cancelOperationBtn = document.getElementById('cancelOperationBtn');
    const cancelScanBtn = document.getElementById('cancelScan');
    const referenceFolderInput = document.getElementById('referenceFolder');
    const scanFilesInput = document.getElementById('scanFiles');
    const btnPickScanFiles = document.getElementById('btnPickScanFiles');
    const scanFilesDisplay = document.getElementById('scanFilesDisplay');
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');

    // Track selected files from folder
    scanFilesInput.addEventListener('change', function() {
        // Show immediate feedback while processing
        if (scanFilesDisplay) {
            scanFilesDisplay.value = 'Processing folder selection...';
            scanFilesDisplay.style.fontStyle = 'italic';
            scanFilesDisplay.style.color = '#6c757d';
        }
        
        // Process files asynchronously to prevent UI freezing
        setTimeout(() => {
            try {
                selectedTargetFiles = Array.from(this.files || []);
                
                // Update display
                if (scanFilesDisplay) {
                    if (selectedTargetFiles.length > 0) {
                        // Try to get the folder name from the relative path of the first file
                        const firstFile = selectedTargetFiles[0];
                        const folderName = firstFile.webkitRelativePath.split('/')[0];
                        scanFilesDisplay.value = `${folderName} (${selectedTargetFiles.length} files)`;
                    } else {
                        scanFilesDisplay.value = '';
                        scanFilesDisplay.placeholder = 'No folder selected';
                    }
                    // Reset styling
                    scanFilesDisplay.style.fontStyle = 'normal';
                    scanFilesDisplay.style.color = '';
                }
                checkFormValidity();
            } catch (error) {
                console.error('Error processing folder selection:', error);
                if (scanFilesDisplay) {
                    scanFilesDisplay.value = 'Error processing folder';
                    scanFilesDisplay.style.color = '#dc3545';
                }
            }
        }, 10); // Small delay to allow UI to update
    });

    // Button triggers hidden file input
    btnPickScanFiles.addEventListener('click', function() {
        try { scanFilesInput.click(); } catch (_) {}
    });

    // Change reference folder
    document.getElementById('changeReferenceFolder').addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;
        
        try {
            // Show loading state
            button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Selecting...';
            button.disabled = true;
            
            const newPath = await window.ScheminiManager.selectFolder('referenceFolder', 'Select New Reference Folder');
            if (newPath) {
                // Show updating state
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin"></i>Updating...';
                
                referenceFolderInput.value = newPath;
                await window.ScheminiManager.updateUserReferenceFolder(newPath);
                
                // Load sections asynchronously
                setTimeout(async () => {
                    try {
                        await loadScanSections();
                        checkFormValidity();
                    } catch (error) {
                        console.error('Error loading sections:', error);
                    }
                }, 10);
            }
        } catch (error) {
            console.error('Error changing reference folder:', error);
        } finally {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });

    // Initialize with Schemini folder if available
    async function initializeFolders() {
        // Prioritize the value rendered from the server
        if (referenceFolderInput.value) {
            await loadScanSections();
            checkFormValidity();
            return;
        }

        // Fallback to old IP-based method if server-rendered value is not present
        try {
            const response = await fetch('/api/user-folder');
            const userFolder = await response.json();
            
            if (userFolder.success && userFolder.folder) {
                referenceFolderInput.value = userFolder.folder;
                try { console.log('SCAN: Reference folder set to:', userFolder.folder); } catch (_) {}
                await loadScanSections();
                checkFormValidity();
            } else {
                referenceFolderInput.placeholder = "Reference folder not configured in settings";
            }
        } catch (error) {
            console.log('Could not load user folder:', error);
            referenceFolderInput.placeholder = "Failed to load reference folder";
        }
    }

    async function loadScanSections() {
        const list = document.getElementById('scanSectionsList');
        const countSpan = document.getElementById('scanSectionsCount');
        
        try {
            // Show loading state
            if (list) {
                list.innerHTML = '<div class="text-center py-3"><i class="bi bi-hourglass-split me-2 spin"></i>Loading sections...</div>';
            }
            
            const base = referenceFolderInput.value || '';
            const url = base ? `/api/file-add/sections?base=${encodeURIComponent(base)}` : '/api/file-add/sections';
            const resp = await fetch(url);
            const json = await resp.json();
            
            if (json.success) {
                availableScanSections = json.data || [];
                renderScanSections();
            } else {
                // Show error state
                if (list) {
                    list.innerHTML = '<div class="text-center py-3 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Failed to load sections</div>';
                }
            }
        } catch (e) {
            // Show error state
            if (list) {
                list.innerHTML = '<div class="text-center py-3 text-danger"><i class="bi bi-wifi-off me-2"></i>Connection error</div>';
            }
            console.error('Error loading sections:', e);
        }
    }

    function renderScanSections() {
        const list = document.getElementById('scanSectionsList');
        const countSpan = document.getElementById('scanSectionsCount');
        list.innerHTML = '';
        selectedScanSections = [];
        availableScanSections.forEach(sec => {
            const id = `scansec_${btoa(unescape(encodeURIComponent(sec.path))).replace(/=/g,'')}`;
            const chip = document.createElement('label');
            chip.className = 'section-chip';
            chip.setAttribute('for', id);
            chip.innerHTML = `
                <input class="scan-section-checkbox" type="checkbox" value="${sec.path}" id="${id}">
                <i class="bi bi-folder2-open"></i>
                <span class="name">${sec.name}</span>
            `;
            list.appendChild(chip);
        });
        document.querySelectorAll('.scan-section-checkbox').forEach(cb => {
            const parent = cb.closest('.section-chip');
            const syncActive = () => { if (cb.checked) parent.classList.add('active'); else parent.classList.remove('active'); };
            parent.addEventListener('click', (e) => {
                if (e.target.tagName.toLowerCase() !== 'input') {
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                    e.preventDefault();
                }
            });
            cb.addEventListener('change', () => {
                syncActive();
                selectedScanSections = Array.from(document.querySelectorAll('.scan-section-checkbox:checked')).map(x => x.value);
                if (countSpan) countSpan.textContent = selectedScanSections.length;
                checkFormValidity();
            });
            syncActive();
        });
        if (countSpan) countSpan.textContent = selectedScanSections.length;
    }

    function checkFormValidity() {
        const hasMain = referenceFolderInput.value.trim();
        const hasSections = selectedScanSections.length > 0;
        const ready = selectedTargetFiles.length > 0;
        const isValid = hasMain && hasSections && ready;
        
        // Update step states
        updateStepStates(hasMain, ready, hasSections, isValid);
        
        // Enable/disable confirm button
        if (confirmStartBtn) {
            confirmStartBtn.disabled = !isValid || isScanning;
        }
        
        // Show/hide operation details based on form validity
        const operationDetailsSection = document.getElementById('operationDetailsSection');
        if (isValid && !isScanning) {
            updateOperationDetails();
            operationDetailsSection.style.display = 'block';
        } else {
            operationDetailsSection.style.display = 'none';
        }
    }
    
    function updateStepStates(hasMain, ready, hasSections, isValid) {
        // Step 1: Reference Folder
        const step1Card = document.getElementById('step1Card');
        const step1Status = document.getElementById('step1Status');
        const step2Card = document.getElementById('step2Card');
        const step2Status = document.getElementById('step2Status');
        const btnPickScanFiles = document.getElementById('btnPickScanFiles');
        const scanFilesDisplay = document.getElementById('scanFilesDisplay');
        const step3Card = document.getElementById('step3Card');
        const step3Status = document.getElementById('step3Status');
        
        if (hasMain) {
            step1Card.classList.remove('disabled');
            step1Card.classList.add('completed');
            step1Status.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Completed';
            step1Status.classList.add('completed');
            
            // Enable Step 2
            step2Card.classList.remove('disabled');
            step2Card.classList.add('active');
            step2Status.innerHTML = '<i class="bi bi-arrow-right-circle me-1"></i>Select folder';
            step2Status.classList.add('active');
            btnPickScanFiles.disabled = false;
            scanFilesDisplay.placeholder = 'Click "Choose Folder" to select';
        } else {
            step1Card.classList.remove('completed', 'active');
            step1Card.classList.add('disabled');
            step1Status.innerHTML = '<i class="bi bi-clock me-1"></i>Pending';
            step1Status.classList.remove('completed', 'active');
            
            // Disable subsequent steps
            step2Card.classList.add('disabled');
            step2Card.classList.remove('active', 'completed');
            step2Status.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Waiting';
            step2Status.classList.remove('completed', 'active');
            btnPickScanFiles.disabled = true;
            scanFilesDisplay.placeholder = 'Complete Step 1 first';
        }
        
        if (ready && hasMain) {
            step2Card.classList.remove('active');
            step2Card.classList.add('completed');
            step2Status.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Completed';
            step2Status.classList.remove('active');
            step2Status.classList.add('completed');
            
            // Enable Step 3
            step3Card.classList.remove('disabled');
            step3Card.classList.add('active');
            step3Status.innerHTML = '<i class="bi bi-arrow-right-circle me-1"></i>Select sections';
            step3Status.classList.add('active');
        } else if (hasMain) {
            step3Card.classList.add('disabled');
            step3Card.classList.remove('active', 'completed');
            step3Status.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Waiting';
            step3Status.classList.remove('completed', 'active');
        }
        
        if (hasSections && ready && hasMain) {
            step3Card.classList.remove('active');
            step3Card.classList.add('completed');
            step3Status.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Completed';
            step3Status.classList.remove('active');
            step3Status.classList.add('completed');
        }
    }
    
    function updateOperationDetails() {
        // Update pre-operation details
        document.getElementById('detailReferenceFolder').textContent = referenceFolderInput.value || 'Not selected';
        
        // Get folder name from selected files
        let folderName = 'No folder selected';
        if (selectedTargetFiles.length > 0) {
            const firstFile = selectedTargetFiles[0];
            folderName = firstFile.webkitRelativePath.split('/')[0];
        }
        document.getElementById('detailCompareFolder').textContent = folderName;
        document.getElementById('detailFileCount').textContent = `${selectedTargetFiles.length} files`;
        
        // Update selected sections
        if (selectedScanSections.length > 0) {
            const sectionNames = selectedScanSections.map(path => {
                const section = availableScanSections.find(s => s.path === path);
                return section ? section.name : path;
            });
            document.getElementById('detailSections').textContent = sectionNames.join(', ');
        } else {
            document.getElementById('detailSections').textContent = 'None selected';
        }
    }

    // Handle form submission through confirm button
    scanForm.addEventListener('submit', function(e) {
        e.preventDefault();
        startScanOperation();
    });
    
    // Confirm & Start button click
    if (confirmStartBtn) {
        confirmStartBtn.addEventListener('click', function(e) {
            e.preventDefault();
            startScanOperation();
        });
    }
    
    // Cancel button click - reset everything
    if (cancelOperationBtn) {
        cancelOperationBtn.addEventListener('click', function() {
            resetFormAndSelections();
        });
    }
    
    function startScanOperation() {
        if (isScanning) return;

        // Clear any existing ZIP monitoring
        if (window.zipLogMonitorInterval) {
            clearInterval(window.zipLogMonitorInterval);
            window.zipLogMonitorInterval = null;
        }

        // IMMEDIATELY show progress section and disable button
        isScanning = true;
        if (confirmStartBtn) confirmStartBtn.disabled = true;
        
        // Show progress section immediately
        document.getElementById('operationDetailsSection').style.display = 'none';
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';

        // Reset progress bar and animation state
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressStatus = document.getElementById('progressStatus');
        const progressCount = document.getElementById('progressCount');
        
        if (progressBar) progressBar.style.width = '0%';
        if (progressText) progressText.textContent = '0%';
        
        // IMMEDIATELY show starting status
        if (progressStatus) progressStatus.textContent = 'Initializing scan operation...';
        if (progressCount) {
            progressCount.textContent = `0/${selectedTargetFiles.length}`;
            progressCount.style.backgroundColor = '#ffc107'; // Yellow for initializing
            progressCount.style.transform = 'scale(1.05)';
        }
        
        currentVisualProgress = 0;
        targetProgress = 0;
        if (progressAnimationInterval) clearInterval(progressAnimationInterval);

        clearLog();
        
        // Start visual progress animation immediately to show activity
        let initProgress = 0;
        const initProgressInterval = setInterval(() => {
            initProgress = Math.min(initProgress + 1, 5); // Progress to 5% during initialization
            if (progressBar) progressBar.style.width = initProgress + '%';
            if (progressText) progressText.textContent = initProgress + '%';
            
            if (initProgress >= 5) {
                clearInterval(initProgressInterval);
            }
        }, 100);
        
        // Process file metadata asynchronously to prevent UI blocking
        setTimeout(() => {
            try {
                if (progressStatus) progressStatus.textContent = 'Preparing file metadata...';
                
                // Extract file metadata in smaller chunks to prevent blocking
                const processFilesInChunks = (files, chunkSize = 100) => {
                    return new Promise((resolve) => {
                        const fileInfoList = [];
                        let index = 0;
                        
                        const processChunk = () => {
                            const chunk = files.slice(index, index + chunkSize);
                            chunk.forEach(file => {
                                fileInfoList.push({
                                    name: file.name,
                                    relativePath: file.webkitRelativePath || file.name,
                                    size: file.size,
                                    lastModified: file.lastModified
                                });
                            });
                            
                            index += chunkSize;
                            
                            if (index < files.length) {
                                // Update progress during metadata processing
                                const metadataProgress = Math.min(5 + (index / files.length) * 5, 10);
                                if (progressBar) progressBar.style.width = metadataProgress + '%';
                                if (progressText) progressText.textContent = Math.round(metadataProgress) + '%';
                                if (progressStatus) progressStatus.textContent = `Processing file metadata... (${index}/${files.length})`;
                                
                                setTimeout(processChunk, 1); // Small delay to keep UI responsive
                            } else {
                                resolve(fileInfoList);
                            }
                        };
                        
                        processChunk();
                    });
                };
                
                processFilesInChunks(selectedTargetFiles).then(fileInfoList => {
                    if (progressStatus) progressStatus.textContent = 'Starting optimized filename-only scan...';
                    if (progressCount) {
                        progressCount.style.backgroundColor = '#17a2b8'; // Blue for processing
                    }
                    
                    const requestData = {
                        main_folder: referenceFolderInput.value.trim(),
                        file_info: fileInfoList,
                        selected_sections: selectedScanSections.length > 0 ? selectedScanSections : null
                    };
                    
                    // Send request to backend
                    fetch('/api/scan-filenames', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        if (progressStatus) progressStatus.textContent = 'Request sent, waiting for backend response...';
                        return response.json();
                    })
                    .then(handleScanStartResponse)
                    .catch(handleScanStartError);
                });
                
            } catch (error) {
                console.error('Error preparing scan:', error);
                handleScanStartError(error);
            }
        }, 50); // Small delay to ensure UI updates are visible
    }
    
    function resetFormAndSelections() {
        // Reset all form inputs
        scanFilesInput.value = '';
        selectedTargetFiles = [];
        selectedScanSections = [];
        
        // Reset display
        if (scanFilesDisplay) {
            scanFilesDisplay.value = '';
            scanFilesDisplay.placeholder = 'Complete Step 1 first';
        }
        
        // Reset sections
        renderScanSections();
        
        // Hide sections
        progressSection.style.display = 'none';
        resultsSection.style.display = 'none';
        
        // Reset operation details section
        const operationDetailsSection = document.getElementById('operationDetailsSection');
        const operationDetailsTitle = document.getElementById('operationDetailsTitle');
        const preOperationDetails = document.getElementById('preOperationDetails');
        const postOperationDetails = document.getElementById('postOperationDetails');
        
        operationDetailsSection.style.display = 'none';
        if (operationDetailsTitle) operationDetailsTitle.textContent = 'Operation Details';
        if (preOperationDetails) preOperationDetails.style.display = 'block';
        if (postOperationDetails) postOperationDetails.style.display = 'none';
        
        // Reset all step cards to initial state
        const step1Card = document.getElementById('step1Card');
        const step2Card = document.getElementById('step2Card');
        const step3Card = document.getElementById('step3Card');
        const step1Status = document.getElementById('step1Status');
        const step2Status = document.getElementById('step2Status');
        const step3Status = document.getElementById('step3Status');
        const btnPickScanFiles = document.getElementById('btnPickScanFiles');
        
        // Reset Step 1
        if (referenceFolderInput.value.trim()) {
            step1Card.classList.remove('disabled');
            step1Card.classList.add('completed');
            step1Status.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Completed';
            step1Status.classList.add('completed');
        } else {
            step1Card.classList.add('disabled');
            step1Card.classList.remove('active', 'completed');
            step1Status.innerHTML = '<i class="bi bi-clock me-1"></i>Pending';
            step1Status.classList.remove('completed', 'active');
        }
        
        // Reset Step 2
        step2Card.classList.add('disabled');
        step2Card.classList.remove('active', 'completed');
        step2Status.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Waiting';
        step2Status.classList.remove('completed', 'active');
        btnPickScanFiles.disabled = true;
        
        // Reset Step 3
        step3Card.classList.add('disabled');
        step3Card.classList.remove('active', 'completed');
        step3Status.innerHTML = '<i class="bi bi-pause-circle me-1"></i>Waiting';
        step3Status.classList.remove('completed', 'active');
        
        // Re-check form validity to update step states properly
        checkFormValidity();
        
        window.ScheminiManager.showNotification('Operation cancelled and form reset', 'info');
    }

    cancelScanBtn.addEventListener('click', function() {
        if (!isScanning) return;
        fetch('/api/cancel-operation/scan', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                // Silent handling
            })
            .catch(err => {
                // Silent error handling
            })
            .finally(() => {
                stopScanning(true); // Force stop UI
            });
    });

    function handleScanStartResponse(result) {
        const progressStatus = document.getElementById('progressStatus');
        const progressCount = document.getElementById('progressCount');
        
        if (result.success) {
            if (progressStatus) {
                progressStatus.textContent = 'Scan started successfully! Indexing reference folder...';
            }
            if (progressCount) {
                progressCount.style.backgroundColor = '#28a745'; // Green for active
            }
            // Start polling immediately
            startProgressPolling();
        } else {
            if (progressStatus) {
                progressStatus.textContent = 'Failed to start scan operation: ' + (result.message || 'Unknown error');
            }
            if (progressCount) {
                progressCount.style.backgroundColor = '#dc3545'; // Red for error
            }
            stopScanning();
        }
    }
    
    function handleScanStartError(error) {
        console.error('Scan start error:', error);
        const progressStatus = document.getElementById('progressStatus');
        const progressCount = document.getElementById('progressCount');
        
        if (progressStatus) {
            progressStatus.textContent = 'Error starting scan operation: ' + (error.message || 'Network error');
        }
        if (progressCount) {
            progressCount.style.backgroundColor = '#dc3545'; // Red for error
        }
        stopScanning();
    }



    function startProgressPolling() {
        // Avoid duplicate intervals
        if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
        let logsSince = 0;
        scanInterval = setInterval(function() {
            fetch(`/api/get-progress/scan?logs_since=${encodeURIComponent(logsSince)}&logs_max=200`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) return;
                    const p = data.progress || {};
                    updateProgress(p);
                    // Complete?
                    const pct = (isFinite(p.percentage) ? Math.round(p.percentage) : 0);
                    if (p.completed || p.error || pct >= 100) {
                        stopProgressPolling();
                        showResults(p);
                    }
                })
                .catch(() => {});
        }, 500);
    }

    function stopProgressPolling() {
        if (scanInterval) {
            clearInterval(scanInterval);
            scanInterval = null;
        }
    }

    function updateProgress(progress) {
        const progressStatus = document.getElementById('progressStatus');
        const progressCount = document.getElementById('progressCount');

        targetProgress = isFinite(progress.percentage) ? Math.round(progress.percentage) : 0;
        
        // Update status with clear indication of what's happening
        const status = progress.status || 'Processing...';
        if (progressStatus) {
            progressStatus.textContent = status;
        }
        
        // Enhanced X/Y counter display - X is current completed, Y is total
        const current = progress.current || 0;  // Files processed so far
        const total = progress.total || 0;      // Total files to process
        
        if (progressCount) {
            progressCount.textContent = `${current}/${total}`;
            
            // Add visual feedback for the counter with better color coding
            if (current > 0 && total > 0) {
                const percentage = (current / total) * 100;
                if (percentage < 25) {
                    progressCount.style.backgroundColor = '#ffc107'; // Yellow for starting
                } else if (percentage < 75) {
                    progressCount.style.backgroundColor = '#17a2b8'; // Blue for progress
                } else {
                    progressCount.style.backgroundColor = '#28a745'; // Green for near completion
                }
                progressCount.style.transform = 'scale(1.05)';
            } else {
                progressCount.style.backgroundColor = '#6c757d'; // Gray when inactive
                progressCount.style.transform = 'scale(1)';
            }
        }

        // Start or update progress animation with smoother transitions
        if (!progressAnimationInterval) {
            progressAnimationInterval = setInterval(() => {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                if (currentVisualProgress < targetProgress) {
                    // Faster animation for better responsiveness
                    const diff = targetProgress - currentVisualProgress;
                    const increment = Math.max(1, Math.ceil(diff / 10)); // Dynamic increment
                    currentVisualProgress = Math.min(currentVisualProgress + increment, targetProgress);
                } else if (currentVisualProgress > targetProgress) {
                    currentVisualProgress = targetProgress; // Snap down if target decreases
                }

                if (progressBar) {
                    progressBar.style.width = currentVisualProgress + '%';
                }
                
                if (progressText) {
                    progressText.textContent = currentVisualProgress + '%';
                }

                if (currentVisualProgress >= 100 || (currentVisualProgress >= targetProgress && targetProgress > 0)) {
                    clearInterval(progressAnimationInterval);
                    progressAnimationInterval = null;
                }
            }, 20); // Faster update interval for smoother animation
        }
    }



    function showResults(progress) {
        stopScanning();
        
        // Transform operation details section to show results
        const operationDetailsSection = document.getElementById('operationDetailsSection');
        const operationDetailsTitle = document.getElementById('operationDetailsTitle');
        const preOperationDetails = document.getElementById('preOperationDetails');
        const postOperationDetails = document.getElementById('postOperationDetails');
        const operationResultsSummary = document.getElementById('operationResultsSummary');
        
        // Update title and show results
        operationDetailsTitle.textContent = 'Operation Results';
        preOperationDetails.style.display = 'none';
        postOperationDetails.style.display = 'block';
        operationDetailsSection.style.display = 'block';
        
        scanJustCompleted = true;  // Mark that scan just completed
        
        // Enable chips immediately after a delay to ensure backend is fully ready
        setTimeout(() => {
            scanJustCompleted = false;
        }, 2000);  // 2 second delay to ensure backend stability

        if (progress.error) {
            operationResultsSummary.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${progress.error}
                </div>
            `;
        } else {
            const pct = isFinite(progress.percentage) ? Math.round(progress.percentage) : 0;
            const total = progress.total || 0;
            const nonMatchedCount = progress.non_matched_count ?? 0;
            const matchedCount = progress.matched_count ?? 0;  // Target files that matched
            const totalScanned = progress.total_scanned ?? total;  // Total target files
            
            // Get unique matched files (X) and total individual matches (Y)
            const uniqueMatchedFiles = progress.matched_groups ?? 0;  // X - unique matched files
            const totalIndividualMatches = progress.matched_total ?? 0;  // Y - total individual matches including duplicates
            
            // Use match percentage from backend (calculated correctly there)
            const matchRatio = progress.match_percentage ?? 0;
            
            // Allow clicking whenever there are non-matched files
            const hasValidPaths = nonMatchedCount > 0;
            // Allow clicking matched chip when there are matched files
            const hasMatchedFiles = uniqueMatchedFiles > 0;

            const clickAttr = hasValidPaths ? 'style="cursor:pointer" onclick="handleNonMatchedClick()"' : '';
            const matchedClickAttr = hasMatchedFiles ? 'style="cursor:pointer" onclick="handleMatchedClick()"' : '';
            
            // Format matched display as X (Y)
            const matchedDisplay = totalIndividualMatches > uniqueMatchedFiles ? 
                `${uniqueMatchedFiles} (${totalIndividualMatches})` : 
                `${uniqueMatchedFiles}`;
            
            operationResultsSummary.innerHTML = `
                <span class="summary-chip bg-info"><i class="bi bi-collection"></i> Scanned <span class="value">${totalScanned}</span></span>
                <span class="summary-chip bg-success ${hasMatchedFiles ? 'clickable' : ''}" ${matchedClickAttr} data-bs-toggle="tooltip" data-bs-placement="top" title="${hasMatchedFiles ? 'Click to download matched files as ZIP' : 'No matched files available'}">
                    <i class="bi bi-check2-circle"></i> Matched <span class="value">${matchedDisplay}</span>
                </span>
                <span class="summary-chip bg-danger ${hasValidPaths ? 'clickable' : ''}" ${clickAttr} data-bs-toggle="tooltip" data-bs-placement="top" title="${hasValidPaths ? 'Click to download non-matched files as ZIP' : 'No non-matched files available'}">
                    <i class="bi bi-x-circle"></i> Non-matched <span class="value">${nonMatchedCount}</span>
                </span>
                <span class="summary-chip bg-warning text-dark"><i class="bi bi-speedometer2"></i> Match Ratio <span class="value">${matchRatio}%</span></span>
            `;
            
            // Initialize Bootstrap tooltips for the new elements
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Hide old results section since we're using the operation details section now
        resultsSection.style.display = 'none';
    }

    function stopScanning(wasCancelled = false) {
        isScanning = false;
        if (confirmStartBtn) confirmStartBtn.disabled = false;
        progressSection.style.display = 'none';
        stopProgressPolling();
        checkFormValidity(); // This will show operation details if form is valid
        
        if (wasCancelled) {
            // Reset operation details to pre-operation state
            const operationDetailsTitle = document.getElementById('operationDetailsTitle');
            const preOperationDetails = document.getElementById('preOperationDetails');
            const postOperationDetails = document.getElementById('postOperationDetails');
            
            operationDetailsTitle.textContent = 'Operation Details';
            preOperationDetails.style.display = 'block';
            postOperationDetails.style.display = 'none';
            
            resultsSection.style.display = 'none';
        }
    }



    // Download non-matched files as ZIP
    function handleNonMatchedClick() {
        // Check if scan just completed, add small delay for reliability
        if (scanJustCompleted) {
            window.ScheminiManager.showNotification('⏳ Scan is completing, please wait...', 'warning');
            setTimeout(() => handleNonMatchedClick(), 1000);
            return;
        }
        
        // Show loading state
        const nonMatchedChip = document.querySelector('.summary-chip.bg-danger.clickable');
        const zipStatusDiv = document.getElementById('zipDownloadStatus');
        const zipStatusTitle = document.getElementById('zipStatusTitle');
        const zipStatusMessage = document.getElementById('zipStatusMessage');
        
        if (nonMatchedChip) {
            nonMatchedChip.classList.add('loading');
            nonMatchedChip.style.pointerEvents = 'none';
        }
        
        if (zipStatusDiv) {
            zipStatusDiv.style.display = 'block';
            zipStatusTitle.textContent = 'Preparing non-matched files...';
            zipStatusMessage.textContent = 'Creating ZIP archive with non-matched files. This may take a few moments.';
        }
        
        // Show immediate feedback with specific message for non-matched files
        window.ScheminiManager.showNotification('🗜️ Preparing non-matched files as ZIP...', 'info');
        
        // Start ZIP creation and download
        fetch('/api/download-non-matched-zip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                operation_type: 'scan'
            })
        })
        .then(response => {
            if (response.ok) {
                // Get filename from response header if available
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'non_matched_files.zip';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Convert response to blob and trigger download
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    window.ScheminiManager.showNotification('✅ Non-matched files ZIP download started!', 'success');
                });
            } else {
                return response.json().then(result => {
                    const errorMsg = result.message || 'Unknown error';
                    window.ScheminiManager.showNotification('Failed to create ZIP: ' + errorMsg, 'error');
                });
            }
        })
        .catch(error => {
            const errorMsg = error.message;
            window.ScheminiManager.showNotification('Error: ' + errorMsg, 'error');
        })
        .finally(() => {
            // Remove loading state
            if (nonMatchedChip) {
                nonMatchedChip.classList.remove('loading');
                nonMatchedChip.style.pointerEvents = 'auto';
            }
            
            if (zipStatusDiv) {
                setTimeout(() => {
                    zipStatusDiv.style.display = 'none';
                }, 2000); // Hide after 2 seconds
            }
        });
    }

    // Download matched files as ZIP
    function handleMatchedClick() {
        // Check if scan just completed, add small delay for reliability
        if (scanJustCompleted) {
            window.ScheminiManager.showNotification('⏳ Scan is completing, please wait...', 'warning');
            setTimeout(() => handleMatchedClick(), 1000);
            return;
        }
        
        // Show loading state
        const matchedChip = document.querySelector('.summary-chip.bg-success.clickable');
        const zipStatusDiv = document.getElementById('zipDownloadStatus');
        const zipStatusTitle = document.getElementById('zipStatusTitle');
        const zipStatusMessage = document.getElementById('zipStatusMessage');
        
        if (matchedChip) {
            matchedChip.classList.add('loading');
            matchedChip.style.pointerEvents = 'none';
        }
        
        if (zipStatusDiv) {
            zipStatusDiv.style.display = 'block';
            zipStatusTitle.textContent = 'Preparing matched files...';
            zipStatusMessage.textContent = 'Creating ZIP archive with matched files. This may take a few moments.';
        }
        
        // Show immediate feedback with specific message for matched files
        window.ScheminiManager.showNotification('🗜️ Preparing matched files as ZIP...', 'info');
        
        // Start ZIP creation and download
        fetch('/api/download-matched-zip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                operation_type: 'scan'
            })
        })
        .then(response => {
            if (response.ok) {
                // Get filename from response header if available
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'matched_files.zip';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Convert response to blob and trigger download
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    window.ScheminiManager.showNotification('✅ Matched files ZIP download started!', 'success');
                });
            } else {
                return response.json().then(result => {
                    const errorMsg = result.message || 'Unknown error';
                    window.ScheminiManager.showNotification('Failed to create ZIP: ' + errorMsg, 'error');
                });
            }
        })
        .catch(error => {
            const errorMsg = error.message;
            window.ScheminiManager.showNotification('Error: ' + errorMsg, 'error');
        })
        .finally(() => {
            // Remove loading state
            if (matchedChip) {
                matchedChip.classList.remove('loading');
                matchedChip.style.pointerEvents = 'auto';
            }
            
            if (zipStatusDiv) {
                setTimeout(() => {
                    zipStatusDiv.style.display = 'none';
                }, 2000); // Hide after 2 seconds
            }
        });
    }



    // Note: Direct ZIP download handlers with real-time feedback
    // Expose click handlers globally for inline onclick in results HTML
    window.handleNonMatchedClick = handleNonMatchedClick;
    window.handleMatchedClick = handleMatchedClick;

    // Initialize form state
    checkFormValidity();
    
    // Initialize folders
    initializeFolders();
    
    // Add download report functionality
    document.addEventListener('click', function(e) {
        if (e.target.id === 'downloadReportBtn' || e.target.closest('#downloadReportBtn')) {
            downloadOperationReport();
        }
    });
    
    function downloadOperationReport() {
        window.ScheminiManager.showNotification('📄 Preparing operation report...', 'info');
        
        fetch('/api/download-operation-log/scan', {
            method: 'GET'
        })
        .then(response => {
            if (response.ok) {
                // Get filename from response header if available
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'scan_operation_report.txt';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Convert response to blob and trigger download
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    window.ScheminiManager.showNotification('✅ Operation report downloaded successfully!', 'success');
                });
            } else {
                return response.json().then(result => {
                    const errorMsg = result.message || 'Failed to generate report';
                    window.ScheminiManager.showNotification('Report Error: ' + errorMsg, 'error');
                });
            }
        })
        .catch(error => {
            const errorMsg = error.message || 'Network error';
            window.ScheminiManager.showNotification('Error downloading report: ' + errorMsg, 'error');
        });
    }

    // Enhanced page close handling for automatic operation cancellation
    let isPageUnloading = false;
    
    function handlePageClose() {
        if (isScanning && !isPageUnloading) {
            isPageUnloading = true;
            
            // Stop progress polling immediately
            stopProgressPolling();
            
            // Send cancellation request to backend
            navigator.sendBeacon('/api/cancel-operation/scan');
            
            // Log the cancellation attempt
            console.log('Page closing - Scan operation cancelled automatically');
        }
    }
    
    // Enhanced page close detection
    window.addEventListener('beforeunload', function(e) {
        if (isScanning) {
            handlePageClose();
            // Show confirmation dialog for user awareness
            e.preventDefault();
            e.returnValue = 'Scan operation is running. Closing will cancel the operation.';
            return e.returnValue;
        }
    });
    
    // Handle tab visibility changes (tab switch, minimize, etc.)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && isScanning) {
            // If tab becomes hidden during operation, cancel it
            handlePageClose();
        }
    });
    
    // Handle page navigation away
    window.addEventListener('pagehide', function() {
        if (isScanning) {
            handlePageClose();
        }
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.btn-cancel {
    background: none !important;
    border: none !important;
    color: #dc3545 !important; /* Bootstrap danger color */
    font-size: 1.5rem;
    padding: 0;
    line-height: 1;
    box-shadow: none !important;
}
.btn-cancel:hover {
    color: #ff0000 !important;
}
.spin { animation: none; }
@keyframes spin { from { transform: none; } to { transform: none; } }
.log-entry { margin-bottom: 0.2rem; }
.bg-black { background-color: #000 !important; }

/* Professional Result Circles */
.result-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    transition: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    border: none;
}

.result-circle:hover {
    transform: none;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.clickable-result {
    cursor: pointer !important;
    position: relative;
}

.clickable-result:hover {
    transform: none;
    box-shadow: 0 8px 16px rgba(0,0,0,0.4);
}

.result-content {
    text-align: center;
    color: white;
}

.result-number {
    font-size: 1.8rem;
    font-weight: bold;
    line-height: 1;
}

.result-label {
    font-size: 0.9rem;
    margin-top: 0.25rem;
    opacity: 0.9;
}

.result-hint {
    font-size: 0.7rem;
    margin-top: 0.2rem;
    opacity: 0.8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .result-circle {
        width: 100px;
        height: 100px;
    }
    .result-number {
        font-size: 1.5rem;
    }
    .result-label {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}
